<div class="netflix-player fade-in">
    <!-- Loading State -->
    <div *ngIf="loading" class="netflix-loader">
        <div class="spinner">
            <div class="bounce1"></div>
            <div class="bounce2"></div>
            <div class="bounce3"></div>
        </div>
        <p>Loading video player...</p>
    </div>

    <!-- Error State -->
    <div *ngIf="error" class="alert alert-danger error-container">
        <i class="bi bi-exclamation-triangle me-2"></i>
        Failed to load the movie for playback. The movie might not exist or there was a server error.
        <div class="mt-3">
            <button (click)="goBack()" class="btn btn-outline-light">
                <i class="bi bi-arrow-left me-2"></i>Go Back
            </button>
        </div>
    </div>

    <!-- Video Player -->
    <div *ngIf="!loading && !error && movie" class="player-container">
        <div class="player-header d-block d-sm-none" [class.hidden]="isPlaying && !controlsVisible">
            <div class="header-content">
                <div class="left-header">
                    <button (click)="goBack()" class="back-button">
                        <i class="bi bi-arrow-left"></i>
                        <span class="back-text">Back to Browse</span>
                    </button>
                </div>
                <div class="center-header">
                    <h1 class="playing-title">{{ movie.title }}</h1>
                </div>
                <div class="right-header">
                </div>
            </div>
        </div>

        <div class="video-container">
            <div class="netflix-theater-mode">
                <!-- Custom Native Video Player -->
                <div *ngIf="isUsingLocalVideo()" class="netflix-video-player">
                    <div class="video-wrapper" (mousemove)="showControls()" (mouseleave)="hideControlsWithDelay()">
                        <!-- Native video element -->
                        <video #videoPlayer [src]="getVideoSourceForQuality()" class="main-video"
                            (timeupdate)="onTimeUpdate()" (loadedmetadata)="onVideoLoaded()" (click)="togglePlayPause()"
                            (ended)="onVideoEnded()" (waiting)="onVideoBuffering(true)"
                            (canplay)="onVideoBuffering(false)" (playing)="onVideoBuffering(false)"
                            (stalled)="onVideoBuffering(true)" preload="auto" crossorigin>
                            Your browser does not support HTML5 video.
                        </video>

                        <!-- Buffering indicator -->
                        <div *ngIf="isBuffering" class="buffering-indicator">
                            <div class="buffering-spinner">
                                <div class="bounce1"></div>
                                <div class="bounce2"></div>
                                <div class="bounce3"></div>
                            </div>
                            <p class="buffering-text">Loading...</p>
                        </div>

                        <!-- Netflix-style video overlay for title display on pause/start -->
                        <div *ngIf="!isPlaying && !isBuffering" class="video-overlay">
                            <div class="title-overlay">
                                <h2>{{ movie.title }}</h2>
                                <div class="play-button-large" (click)="togglePlayPause()">
                                    <i class="bi bi-play-fill"></i>
                                </div>
                            </div>
                        </div>

                        <!-- Custom video controls -->
                        <div class="custom-controls" [class.visible]="controlsVisible"
                            [class.hidden]="!controlsVisible">
                            <!-- Progress bar -->
                            <div class="progress-container">
                                <div class="progress-bar-bg" (click)="onProgressBarClick($event)">
                                    <div class="buffered-bar" [style.width.%]="bufferedPercent"></div>
                                    <div class="progress-bar" [style.width.%]="progressPercent"></div>
                                    <input type="range" class="seek-slider" min="0" max="100" step="0.1"
                                        [value]="progressPercent" (input)="onSeekBarInput($event)">
                                </div>
                            </div>

                            <!-- Controls row -->
                            <div class="controls-row">
                                <div class="left-controls">
                                    <button class="control-button" (click)="togglePlayPause()">
                                        <i class="bi" [ngClass]="isPlaying ? 'bi-pause-fill' : 'bi-play-fill'"></i>
                                    </button>

                                    <button class="control-button" (click)="skipBackward()">
                                        <i class="bi bi-skip-backward-fill"></i>
                                    </button>

                                    <button class="control-button" (click)="skipForward()">
                                        <i class="bi bi-skip-forward-fill"></i>
                                    </button>

                                    <div class="volume-control">
                                        <button class="control-button" (click)="toggleMute()">
                                            <i class="bi"
                                                [ngClass]="isMuted ? 'bi-volume-mute-fill' : 'bi-volume-up-fill'"></i>
                                        </button>
                                        <div class="volume-slider-container">
                                            <input type="range" class="volume-slider" min="0" max="100"
                                                [value]="volumeLevel" (input)="onVolumeChange($event)"
                                                aria-label="Volume Level">
                                        </div>
                                    </div>

                                    <div class="time-display">
                                        <span>{{ currentTime | time }} / {{ totalDuration | time }}</span>
                                    </div>
                                </div>

                                <div class="right-controls">
                                    <!-- Quality Selection -->
                                    <div class="quality-selector">
                                        <button class="control-button" (click)="toggleQualityOptions()"
                                            title="Video Quality">
                                            <i class="bi bi-badge-hd"></i>
                                        </button>
                                        <div class="quality-options" *ngIf="qualityOptionsVisible">
                                            <div class="quality-title">Video Quality</div>
                                            <button *ngFor="let quality of availableQualities"
                                                (click)="setVideoQuality(quality.value)"
                                                [class.active]="currentQuality === quality.value">
                                                {{ quality.label }}
                                            </button>
                                            <div class="quality-info">Demo Only</div>
                                        </div>
                                    </div>

                                    <div class="playback-speed">
                                        <button class="control-button" (click)="toggleSpeedOptions()"
                                            title="Playback Speed">
                                            <span>{{ currentPlaybackSpeed }}x</span>
                                        </button>
                                        <div class="speed-options" *ngIf="speedOptionsVisible">
                                            <div class="speed-title">Playback Speed</div>
                                            <button *ngFor="let speed of playbackSpeeds"
                                                (click)="setPlaybackSpeed(speed)"
                                                [class.active]="currentPlaybackSpeed === speed">
                                                {{ speed }}x
                                            </button>
                                        </div>
                                    </div>

                                    <button class="control-button" (click)="toggleFullscreen()" title="Fullscreen">
                                        <i class="bi"
                                            [ngClass]="isFullscreen ? 'bi-fullscreen-exit' : 'bi-fullscreen'"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- YouTube Player -->
                <div *ngIf="isUsingYoutubeVideo()" class="youtube-video-player">
                    <iframe width="100%" height="100%" [src]="youtubeVideoUrl" frameborder="0"
                        allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
                        allowfullscreen>
                    </iframe>
                </div>

                <!-- No Video Source Available -->
                <div *ngIf="!isUsingLocalVideo() && !isUsingYoutubeVideo()" class="no-video-message">
                    <div class="alert alert-warning">
                        <i class="bi bi-exclamation-triangle me-2"></i>
                        No video source available for this movie.
                    </div>
                </div>
            </div>
        </div>

        <div class="container">
            <div class="details-content">
                <div class="row">
                    <div class="col-lg-4 col-md-5">
                        <div class="poster-container">
                            <img [src]="movie.posterUrl" [alt]="movie.title + ' poster'" class="main-poster">

                            <div class="rating-badge-large">
                                <span class="rating-value">{{ movie.rating }}</span>
                                <span class="rating-max">/10</span>
                            </div>

                            <div class="release-status-badge" *ngIf="movie.releaseDate === null">
                                COMING SOON
                            </div>
                        </div>

                    </div>

                    <div class="col-lg-8 col-md-7">
                        <div class="details-info">
                            <h1 class="movie-title">{{ movie.title }} <span class="movie-year">({{ movie.releaseYear
                                    }})</span></h1>

                            <div class="movie-metadata">
                                <span class="release-date">{{ formatDate(movie.releaseDate) }}</span>
                                <span class="separator">•</span>
                                <span class="duration">{{ movie.duration }} min</span>
                                <span class="separator">•</span>
                                <span class="rating">{{ movie.rating }}/10</span>
                            </div>

                            <div class="genres-container">
                                <span *ngFor="let genre of movie.genre" class="genre-pill">{{ genre }}</span>
                            </div>

                            <div class="synopsis">
                                <h3>Synopsis</h3>
                                <p>{{ movie.description }}</p>
                            </div>

                            <div class="director-info">
                                <h3>Director</h3>
                                <p>{{ movie.director }}</p>
                            </div>

                            <div class="technical-details">
                                <h3>Details</h3>
                                <table class="details-table">
                                    <tbody>
                                        <tr>
                                            <td>Release Year</td>
                                            <td>{{ movie.releaseYear }}</td>
                                        </tr>
                                        <tr>
                                            <td>Release Date</td>
                                            <td>{{ formatDate(movie.releaseDate) }}</td>
                                        </tr>
                                        <tr>
                                            <td>Duration</td>
                                            <td>{{ movie.duration }} minutes</td>
                                        </tr>
                                        <tr>
                                            <td>Rating</td>
                                            <td>{{ movie.rating }} / 10</td>
                                        </tr>
                                        <tr>
                                            <td>Genres</td>
                                            <td>{{ movie.genre.join(', ') }}</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>